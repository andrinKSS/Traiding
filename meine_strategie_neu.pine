//@version=6
strategy(
    "BB Trading Strategie – Dynamisch",
    overlay = true,
    initial_capital = 10000,
    default_qty_type = strategy.percent_of_equity,
    default_qty_value = 10,
    pyramiding = 0,
    calc_on_every_tick = true,
    commission_type = strategy.commission.percent,
    commission_value = 0.05
)

// ===============================
// Bollinger Bands
// ===============================
length = input.int(20)
mult   = input.float(2.0)

basis = ta.sma(close, length)
dev   = mult * ta.stdev(close, length)
upper = basis + dev
lower = basis - dev

plot(basis, "Basis", color=color.blue, linewidth=2)
p1 = plot(upper, "Upper", color=color.red)
p2 = plot(lower, "Lower", color=color.green)
fill(p1, p2, color.new(color.blue, 90))

// ===============================
// Status
// ===============================
hasPos  = strategy.position_size != 0
isLong  = strategy.position_size > 0
isShort = strategy.position_size < 0

// ===============================
// ENTRY – SOFORT BEI TOUCH
// ===============================
longSignal  = low <= lower and not hasPos
shortSignal = high >= upper and not hasPos

if longSignal
    strategy.entry("Long", strategy.long)

if shortSignal
    strategy.entry("Short", strategy.short)

// ===============================
// EXIT LOGIK (DYNAMISCH)
// ===============================

// TP1 → Basis (50%)
if hasPos
    strategy.exit(
        id = "TP1",
        from_entry = isLong ? "Long" : "Short",
        limit = basis,
        qty_percent = 50
    )

// TP2 → Gegenband (Rest)
if hasPos
    strategy.exit(
        id = "TP2",
        from_entry = isLong ? "Long" : "Short",
        limit = isLong ? upper : lower,
        qty_percent = 100
    )

// ===============================
// VISUAL DEBUG
// ===============================
plotshape(longSignal,  style=shape.triangleup,   location=location.belowbar, color=color.green, size=size.small)
plotshape(shortSignal, style=shape.triangledown, location=location.abovebar, color=color.red,   size=size.small)
