//@version=6
strategy("BB Trading Strategie Korrigiert", overlay=true, 
     initial_capital=10000, 
     default_qty_type=strategy.percent_of_equity, 
     default_qty_value=10,
     pyramiding=0,
     calc_on_every_tick=true)  // Wichtig: Berechnung bei jedem Tick für sofortige Entries

// === Bollinger Bands Einstellungen ===
length = input.int(20, minval=1, title="BB Länge")
maType = input.string("SMA", "Basis MA Type", options = ["SMA", "EMA", "SMMA (RMA)", "WMA", "VWMA"])
src = input(close, title="Source")
mult = input.float(2.0, minval=0.001, maxval=50, title="StdDev")

ma(source, length, _type) =>
    switch _type
        "SMA" => ta.sma(source, length)
        "EMA" => ta.ema(source, length)
        "SMMA (RMA)" => ta.rma(source, length)
        "WMA" => ta.wma(source, length)
        "VWMA" => ta.vwma(source, length)

basis = ma(src, length, maType)
dev = mult * ta.stdev(src, length)
upper = basis + dev
lower = basis - dev

// === Plot ===
plot(basis, "Basis", color=#2962FF)
p1 = plot(upper, "Upper", color=#F23645)
p2 = plot(lower, "Lower", color=#089981)
fill(p1, p2, color=color.new(color.blue, 90))

// === Variablen ===
var bool waitForBasis = false
var float entryPrice = na
var float initialStopLoss = na
var float tp1Price = na
var float tp2Price = na
var bool tp1Reached = false

// Basis-Touch Check für Warte-Modus
basisTouch = (low <= basis and high >= basis)
if waitForBasis and basisTouch
    waitForBasis := false

// === Entry Bedingungen ===
// Verwende low/high für intrabar detection, nicht close
longCondition  = low <= lower and strategy.position_size == 0 and not waitForBasis
shortCondition = high >= upper and strategy.position_size == 0 and not waitForBasis

// === LONG ENTRY ===
if longCondition
    entryPrice := close
    tp1Price := basis
    tp2Price := upper
    // SL = Abstand Entry zu Basis gespiegelt nach unten
    distanceToBasis = basis - close
    initialStopLoss := close - distanceToBasis
    tp1Reached := false
    
    strategy.entry("Long", strategy.long)

// === SHORT ENTRY ===
if shortCondition
    entryPrice := close
    tp1Price := basis
    tp2Price := lower
    // SL = Abstand Entry zu Basis gespiegelt nach oben
    distanceToBasis = close - basis
    initialStopLoss := close + distanceToBasis
    tp1Reached := false
    
    strategy.entry("Short", strategy.short)

// === EXIT MANAGEMENT ===
if strategy.position_size > 0  // Long Position
    if not tp1Reached
        // Phase 1: TP1 für 50%, SL für Rest
        strategy.exit("Long Exit1", "Long", qty_percent=50, limit=tp1Price, stop=initialStopLoss)
        
        // Check ob TP1 erreicht wurde
        if high >= tp1Price
            tp1Reached := true
    else
        // Phase 2: Nach TP1 - cancel alte Order und setze neue mit BE
        strategy.cancel("Long Exit1")
        strategy.exit("Long Exit2", "Long", limit=tp2Price, stop=entryPrice)

if strategy.position_size < 0  // Short Position
    if not tp1Reached
        // Phase 1: TP1 für 50%, SL für Rest
        strategy.exit("Short Exit1", "Short", qty_percent=50, limit=tp1Price, stop=initialStopLoss)
        
        // Check ob TP1 erreicht wurde
        if low <= tp1Price
            tp1Reached := true
    else
        // Phase 2: Nach TP1 - cancel alte Order und setze neue mit BE
        strategy.cancel("Short Exit1")
        strategy.exit("Short Exit2", "Short", limit=tp2Price, stop=entryPrice)

// === Position wurde geschlossen ===
if strategy.position_size == 0 and (strategy.position_size[1] != 0 or not na(entryPrice))
    // Check ob letzter Trade Verlust war
    if strategy.closedtrades > 0
        lastTradeIndex = strategy.closedtrades - 1
        if strategy.closedtrades.profit(lastTradeIndex) < 0
            waitForBasis := true
    
    // WICHTIG: Reset ALLE Variablen sofort
    tp1Reached := false
    entryPrice := na
    initialStopLoss := na
    tp1Price := na
    tp2Price := na

// === Anzeige ===
bgcolor(strategy.position_size != 0 ? color.new(color.blue, 90) : na)
plotshape(longCondition ? lower : na, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small)
plotshape(shortCondition ? upper : na, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)

// Debug: Zeige SL und TP Levels wenn Position offen
plot(strategy.position_size != 0 and not na(initialStopLoss) ? initialStopLoss : na, "SL", color=color.red, linewidth=2, style=plot.style_cross)
plot(strategy.position_size != 0 and not tp1Reached and not na(tp1Price) ? tp1Price : na, "TP1", color=color.blue, linewidth=1, style=plot.style_circles)
plot(strategy.position_size != 0 and not na(tp2Price) ? tp2Price : na, "TP2", color=color.orange, linewidth=1, style=plot.style_circles)
