//@version=6
strategy(
    "BB Trading Strategie – STABIL FINAL",
    overlay = true,
    initial_capital = 1000,
    default_qty_type = strategy.percent_of_equity,
    default_qty_value = 10,
    pyramiding = 0,
    calc_on_every_tick = true,
    commission_type = strategy.commission.percent,
    commission_value = 0.05
)

// ===============================
// Bollinger Bands
// ===============================
length = input.int(20, "BB Länge")
mult   = input.float(2.0, "Multiplikator")

basis = ta.sma(close, length)
dev   = mult * ta.stdev(close, length)
upper = basis + dev
lower = basis - dev

plot(basis, "Basis", color=color.blue, linewidth=2)
p1 = plot(upper, "Obere Linie (ROT)", color=color.red)
p2 = plot(lower, "Untere Linie (GRÜN)", color=color.green)
fill(p1, p2, color.new(color.blue, 90))

// ===============================
// Persistente Trade-Daten
// ===============================
var float entryPrice = na
var float stopFix    = na
var bool  tp1Hit     = false
var int   tradeDir   = 0   // 1 = Long, -1 = Short

hasPos = strategy.position_size != 0

// ===============================
// ENTRY – sofort bei Touch
// ===============================
if low <= lower and not hasPos
    strategy.entry("Long", strategy.long)
if high >= upper and not hasPos
    strategy.entry("Short", strategy.short)

// ===============================
// INITIALISIERUNG NACH FILL
// ===============================
if na(entryPrice) and hasPos
    entryPrice := strategy.position_avg_price
    tradeDir   := strategy.position_size > 0 ? 1 : -1

    dist = math.abs(entryPrice - basis)
    stopFix := tradeDir == 1 ? entryPrice - dist : entryPrice + dist

    tp1Hit := false

// ===============================
// PHASE 1 – TP1 (50 %) + fixer SL
// ===============================
if hasPos and not tp1Hit
    // 50%-TP nur als Limit
    strategy.exit(
        id = "Phase1",
        from_entry = tradeDir == 1 ? "Long" : "Short",
        qty_percent = 50,
        limit = basis,
        stop  = na
    )
    // Voll-SL separat, solange TP1 nicht getroffen
    strategy.exit(
        id = "StopFull",
        from_entry = tradeDir == 1 ? "Long" : "Short",
        qty_percent = 100,
        stop = stopFix,
        limit = na
    )

// TP1 HIT DETECTION – nur bei Kurs-Touch der Basis, nicht bei SL-Fill
if hasPos and not tp1Hit
    tp1Hit := tradeDir == 1 ? high >= basis : low <= basis
    if tp1Hit
        strategy.cancel("StopFull")

// ===============================
// PHASE 2 – TP2 + Break-Even
// ===============================
if hasPos and tp1Hit
    strategy.exit(
        id = "Phase2",
        from_entry = tradeDir == 1 ? "Long" : "Short",
        limit = tradeDir == 1 ? upper : lower,
        stop  = entryPrice
    )

// ===============================
// RESET nach Positionsende
// ===============================
if hasPos[1] and not hasPos
    entryPrice := na
    stopFix := na
    tp1Hit := false
    tradeDir := 0
    strategy.cancel("StopFull")

// ===============================
// VISUAL DEBUG
// ===============================
plot(stopFix, "SL", color=color.red, linewidth=2, style=plot.style_cross)
plot(basis, "TP1", color=color.blue)
plot(tradeDir == 1 ? upper : tradeDir == -1 ? lower : na, "TP2", color=color.orange)

plotshape(low <= lower and not hasPos, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small)
plotshape(high >= upper and not hasPos, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small)
