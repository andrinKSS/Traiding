//@version=6
strategy(
    "BB Trading Strategie – TARGET OUTER (Fixed)",
    overlay = true,
    initial_capital = 1000,
    default_qty_type = strategy.percent_of_equity,
    default_qty_value = 10,
    pyramiding = 0,
    calc_on_every_tick = true,
    commission_type = strategy.commission.percent,
    commission_value = 0.05
)

// === INPUTS & INDIKATOREN ===
length = input.int(20, "BB Länge")
mult   = input.float(2.0, "Multiplikator")

basis = ta.sma(close, length)
dev   = mult * ta.stdev(close, length)
upper = basis + dev
lower = basis - dev

// Plotting
plot(basis, "Basis", color=color.blue, linewidth=2)
p1 = plot(upper, "Upper", color=color.red)
p2 = plot(lower, "Lower", color=color.green)
fill(p1, p2, color.new(color.blue, 90))

// === STATUS-MANAGEMENT ===
var int stage = 0 
var float entryPrice = na
var float slPrice = na
var int tradeDir = 0 // 1=Long, -1=Short
var bool waitingForBasisTouch = false 
var int lastTradeDir = 0 

isPos = strategy.position_size != 0
posDir = strategy.position_size > 0 ? 1 : (strategy.position_size < 0 ? -1 : 0)

// === RESET LOGIK ===
if not isPos and stage != 0
    lastTradeDir := tradeDir 
    stage := 0
    entryPrice := na
    slPrice := na
    tradeDir := 0
    waitingForBasisTouch := true 
    strategy.cancel_all()

// === WARTEN AUF BASIS-TOUCH (optional, bleibt als Filter aktiv) ===
if waitingForBasisTouch
    basistouched = (lastTradeDir == 1 and high >= basis) or (lastTradeDir == -1 and low <= basis)
    if basistouched
        waitingForBasisTouch := false

// === ENTRY LOGIK ===
if not isPos and not waitingForBasisTouch
    strategy.entry("Long Entry", strategy.long, limit=lower)
    strategy.entry("Short Entry", strategy.short, limit=upper)
else
    strategy.cancel("Long Entry")
    strategy.cancel("Short Entry")

// === INITIALISIERUNG BEI FILL ===
if isPos and stage == 0
    stage := 1
    tradeDir := posDir
    entryPrice := strategy.position_avg_price
    
    // SL mit 0.56% Abstand
    float slPercent = 0.56 / 100
    slPrice := tradeDir == 1 ? entryPrice * (1 - slPercent) : entryPrice * (1 + slPercent)

// === EXIT LOGIK ===
if stage == 1
    // ÄNDERUNG: TP ist jetzt das dynamische Band (Upper bei Long, Lower bei Short)
    float tpLimit = tradeDir == 1 ? upper : lower

    strategy.exit("TP Full", 
         qty_percent = 100, 
         limit = tpLimit, 
         stop = slPrice)

    // Stage update falls TP visuell getroffen (für Plotting Logik)
    if strategy.opentrades > 0
        bool tpHitLong = tradeDir == 1 and high >= upper
        bool tpHitShort = tradeDir == -1 and low <= lower
        // Hinweis: Da wir 100% schließen, brauchen wir stage 2 eigentlich nicht mehr zwingend für BE,
        // aber wir lassen die Struktur sauber.

// === VISUALISIERUNG ===
plot(stage > 0 ? slPrice : na, "SL Fix", color=color.red, style=plot.style_cross)
plot(stage > 0 ? entryPrice : na, "Entry", color=color.gray, style=plot.style_circles)





// Ein TP bei äußerem Band und SL angegeben in Prozenten 