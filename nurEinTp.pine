//@version=6
strategy(
    "BB Trading Strategie – STABIL FINAL (Fixed)",
    overlay = true,
    initial_capital = 1000,
    default_qty_type = strategy.percent_of_equity,
    default_qty_value = 10,
    pyramiding = 0,
    calc_on_every_tick = true, // Wichtig für sofortige Reaktion
    commission_type = strategy.commission.percent,
    commission_value = 0.05
)

// === INPUTS & INDIKATOREN ===
length = input.int(20, "BB Länge")
mult   = input.float(2.0, "Multiplikator")

basis = ta.sma(close, length)
dev   = mult * ta.stdev(close, length)
upper = basis + dev
lower = basis - dev

// Plotting
plot(basis, "Basis", color=color.blue, linewidth=2)
p1 = plot(upper, "Upper", color=color.red)
p2 = plot(lower, "Lower", color=color.green)
fill(p1, p2, color.new(color.blue, 90))

// === STATUS-MANAGEMENT ===
// stage 0: Keine Pos | 1: Offen, warte TP
var int stage = 0 
var float entryPrice = na
var float slPrice = na
var int tradeDir = 0 // 1=Long, -1=Short
var bool waitingForBasisTouch = false // Warten auf Basis-Touch nach SL
var int lastTradeDir = 0 // Speichert die letzte Trade-Richtung für Basis-Touch-Check

isPos = strategy.position_size != 0
posDir = strategy.position_size > 0 ? 1 : (strategy.position_size < 0 ? -1 : 0)

// === RESET LOGIK ===
// Position closed -> reset alles
if not isPos and stage != 0
    lastTradeDir := tradeDir // Speichern für Basis-Touch-Check
    stage := 0
    entryPrice := na
    slPrice := na
    tradeDir := 0
    waitingForBasisTouch := true // Nach SL: warten auf Basis-Touch
    strategy.cancel_all()

// === WARTEN AUF BASIS-TOUCH ===
// Kurs muss Basis einmal berühren bevor neue Positionen eröffnet werden
if waitingForBasisTouch
    basistouched = (lastTradeDir == 1 and high >= basis) or (lastTradeDir == -1 and low <= basis)
    if basistouched
        waitingForBasisTouch := false

// === ENTRY LOGIK ===
// Limit-Orders auf den Bändern (nur wenn nicht auf Basis-Touch wartend)
if not isPos and not waitingForBasisTouch
    strategy.entry("Long Entry", strategy.long, limit=lower)
    strategy.entry("Short Entry", strategy.short, limit=upper)
else
    strategy.cancel("Long Entry")
    strategy.cancel("Short Entry")

// === INITIALISIERUNG BEI FILL ===
if isPos and stage == 0
    stage := 1
    tradeDir := posDir
    entryPrice := strategy.position_avg_price
    
    // SL mit Abstand zur Basis
    dist = math.abs(entryPrice - basis)
    slPrice := tradeDir == 1 ? entryPrice - dist : entryPrice + dist

// === EXIT LOGIK - PHASE 1 ===
if stage == 1
    // 50% bei Basis
    strategy.exit("TP1", 
         qty_percent = 100, 
         limit = basis, 
         stop = slPrice)

    if strategy.opentrades > 0
        bool tpHitLong = tradeDir == 1 and high >= basis
        bool tpHitShort = tradeDir == -1 and low <= basis
        if math.abs(strategy.position_size) < math.abs(strategy.position_size[1]) 
            stage := 2 

// === VISUALISIERUNG ===
plot(stage > 0 ? slPrice : na, "SL Fix", color=color.red, style=plot.style_cross)
plot(stage == 2 ? entryPrice : na, "BreakEven", color=color.gray, style=plot.style_circles)




// Ein TP bei Mittelwert (Basis) und SL mit Abstand zur Basis